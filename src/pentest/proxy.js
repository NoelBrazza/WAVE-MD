const { HttpsProxyAgent } = require('https-proxy-agent');
const axios = require('axios');

let proxyAgent = null;

const startProxy = (proxyConfig) => {
  return new Promise((resolve, reject) => {
    if (proxyAgent) {
      return resolve('!! Proxy is already running!');
    }

    proxyAgent = new HttpsProxyAgent(`http://${proxyConfig.host}:${proxyConfig.port}`);
    ponfigureAxios();
    resolve(`!! Proxy started through ${proxyConfig.host}:${proxyConfig.port}`);
  });
};

const stopProxy = () => {
  if (!proxyAgent) {
    return 'No proxy is running!';
  }

  proxyAgent = null;
  ponfigureAxios();

  return '!! Proxy stopped';
};

const ponfigureAxios = () => {
  if (proxyAgent) {
    axios.defaults.httpsAgent = proxyAgent;
  } else {
    delete axios.defaults.httpsAgent;
  }
};

module.exports = {
  startProxy,
  stopProxy,
  ponfigureAxios
};
